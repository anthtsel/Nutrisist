{% extends "base.html" %}

{% block title %}Garmin Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div id="alertContainer" class="mb-4"></div>
    <h1>Garmin Connect Dashboard</h1>
    
    <div class="row mb-4">
        <div class="col">
            <button id="connectGarmin" class="btn btn-primary">Connect to Garmin</button>
        </div>
    </div>

    <div class="row">
        <!-- Heart Rate Card -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Heart Rate</h5>
                </div>
                <div class="card-body">
                    <div id="heartRateData">
                        <p class="text-muted">No data available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Steps Card -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Steps</h5>
                </div>
                <div class="card-body">
                    <div id="stepsData">
                        <p class="text-muted">No data available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sleep Card -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Sleep</h5>
                </div>
                <div class="card-body">
                    <div id="sleepData">
                        <p class="text-muted">No data available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Card -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Devices</h5>
                </div>
                <div class="card-body">
                    <div id="devicesData">
                        <p class="text-muted">No devices connected</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2">Connecting to Garmin...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const connectButton = document.getElementById('connectGarmin');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    const alertContainer = document.getElementById('alertContainer');

    // Check if we're returning from OAuth callback
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) {
        handleOAuthCallback(code);
        return;
    }

    connectButton.addEventListener('click', async function() {
        try {
            console.log('Initiating Garmin OAuth flow...');
            loadingModal.show();
            
            // Start OAuth flow
            const response = await fetch('/garmin/connect');
            const result = await response.json();
            console.log('OAuth response:', result);
            
            if (result.status === 'redirect') {
                // Redirect to Garmin OAuth page
                window.location.href = result.auth_url;
            } else {
                console.error('Failed to initiate OAuth:', result.message);
                showAlert('danger', result.message);
            }
        } catch (error) {
            console.error('Error initiating OAuth:', error);
            showAlert('danger', 'Error initiating OAuth: ' + error.message);
        } finally {
            loadingModal.hide();
        }
    });

    async function handleOAuthCallback(code) {
        try {
            console.log('Handling OAuth callback...');
            loadingModal.show();
            
            // Exchange code for access token
            const response = await fetch(`/garmin/callback?code=${code}`);
            const result = await response.json();
            console.log('Callback response:', result);
            
            if (result.status === 'success') {
                console.log('Connection successful, updating UI with data:', result.data);
                // Update the UI with the data
                updateHeartRateData(result.data.heart_rate);
                updateStepsData(result.data.steps);
                updateSleepData(result.data.sleep);
                updateDevicesData(result.data.devices);
                
                // Show success message
                showAlert('success', 'Successfully connected to Garmin!');
                
                // Remove code from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                console.error('Connection failed:', result.message);
                showAlert('danger', result.message);
            }
        } catch (error) {
            console.error('Error handling OAuth callback:', error);
            showAlert('danger', 'Error handling OAuth callback: ' + error.message);
        } finally {
            loadingModal.hide();
        }
    }

    function updateHeartRateData(heartRateData) {
        console.log('Updating heart rate data:', heartRateData);
        const container = document.getElementById('heartRateData');
        if (heartRateData && heartRateData.length > 0) {
            const latest = heartRateData[heartRateData.length - 1];
            container.innerHTML = `
                <h3>${latest.value} bpm</h3>
                <p class="text-muted">Latest reading</p>
                <p>Total readings: ${heartRateData.length}</p>
            `;
        } else {
            container.innerHTML = '<p class="text-muted">No heart rate data available</p>';
        }
    }

    function updateStepsData(stepsData) {
        console.log('Updating steps data:', stepsData);
        const container = document.getElementById('stepsData');
        if (stepsData && stepsData.length > 0) {
            const totalSteps = stepsData.reduce((sum, step) => sum + (step.steps || 0), 0);
            container.innerHTML = `
                <h3>${totalSteps}</h3>
                <p class="text-muted">Total steps today</p>
                <p>Data points: ${stepsData.length}</p>
            `;
        } else {
            container.innerHTML = '<p class="text-muted">No steps data available</p>';
        }
    }

    function updateSleepData(sleepData) {
        console.log('Updating sleep data:', sleepData);
        const container = document.getElementById('sleepData');
        if (sleepData) {
            const duration = Math.round(sleepData.duration / 3600 * 10) / 10;
            const deepSleep = Math.round(sleepData.deepSleepDuration / 3600 * 10) / 10;
            const lightSleep = Math.round(sleepData.lightSleepDuration / 3600 * 10) / 10;
            
            container.innerHTML = `
                <h3>${duration} hours</h3>
                <p class="text-muted">Total sleep duration</p>
                <p>Deep sleep: ${deepSleep} hours</p>
                <p>Light sleep: ${lightSleep} hours</p>
            `;
        } else {
            container.innerHTML = '<p class="text-muted">No sleep data available</p>';
        }
    }

    function updateDevicesData(devices) {
        console.log('Updating devices data:', devices);
        const container = document.getElementById('devicesData');
        if (devices && devices.length > 0) {
            const deviceList = devices.map(device => `
                <div class="mb-2">
                    <strong>${device.productDisplayName || 'Unknown Device'}</strong>
                    <br>
                    <small class="text-muted">ID: ${device.deviceId || 'N/A'}</small>
                </div>
            `).join('');
            container.innerHTML = deviceList;
        } else {
            container.innerHTML = '<p class="text-muted">No devices connected</p>';
        }
    }

    function showAlert(type, message) {
        console.log('Showing alert:', type, message);
        // Clear any existing alerts
        alertContainer.innerHTML = '';
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alertDiv);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
});
</script>
{% endblock %} 