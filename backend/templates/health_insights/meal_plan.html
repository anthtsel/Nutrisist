{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Nutrition Profile -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Your Nutrition Profile</h3>
                </div>
                <div class="card-body">
                    <div id="nutritionProfile">
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Daily Calories</h5>
                                <div class="display-4 mb-3" id="dailyCalories">-</div>
                            </div>
                            <div class="col-md-8">
                                <h5>Macronutrient Distribution</h5>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar bg-primary" id="proteinBar" role="progressbar"></div>
                                    <div class="progress-bar bg-success" id="carbsBar" role="progressbar"></div>
                                    <div class="progress-bar bg-warning" id="fatBar" role="progressbar"></div>
                                </div>
                                <div class="row text-center">
                                    <div class="col">
                                        <small class="text-primary">Protein</small>
                                        <div id="proteinGrams">-</div>
                                    </div>
                                    <div class="col">
                                        <small class="text-success">Carbs</small>
                                        <div id="carbsGrams">-</div>
                                    </div>
                                    <div class="col">
                                        <small class="text-warning">Fat</small>
                                        <div id="fatGrams">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meal Preferences Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Meal Preferences</h3>
                </div>
                <div class="card-body">
                    <form id="mealPreferencesForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dietary-type" class="form-label">Dietary Type</label>
                                    <select class="form-select" id="dietary-type" name="dietary_type">
                                        <option value="balanced">Balanced</option>
                                        <option value="vegetarian">Vegetarian</option>
                                        <option value="vegan">Vegan</option>
                                        <option value="keto">Keto</option>
                                        <option value="paleo">Paleo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="meal-count" class="form-label">Meals per Day</label>
                                    <select class="form-select" id="meal-count" name="meal_count">
                                        <option value="4">4 (Breakfast, Lunch, Snack, Dinner)</option>
                                        <option value="5">5 (+ Morning Snack)</option>
                                        <option value="6">6 (+ Evening Snack)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="excluded-foods" class="form-label">Excluded Foods</label>
                                    <input type="text" class="form-control" id="excluded-foods" name="excluded_foods" 
                                           placeholder="Enter foods to exclude (comma-separated)">
                                    <small class="text-muted">Example: nuts, shellfish, dairy</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="servings" class="form-label">Servings</label>
                                    <select class="form-select" id="servings" name="servings">
                                        <option value="1">1 serving</option>
                                        <option value="2">2 servings</option>
                                        <option value="4">4 servings (Family)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Meal Plan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Meal Plan -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Weekly Meal Plan</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="previousDay">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="btn btn-outline-primary" id="currentDay" disabled>Day 1</button>
                        <button class="btn btn-outline-primary" id="nextDay">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="meal-plan">
                        <!-- Meal plan will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grocery List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Grocery List</h3>
                </div>
                <div class="card-body">
                    <div id="grocery-list">
                        <!-- Grocery list will be populated here -->
                    </div>
                    <div id="shopping-links" class="mt-4">
                        <h4>Order Groceries</h4>
                        <div class="d-flex gap-3">
                            <a id="instacart-link" href="#" target="_blank" class="btn btn-primary" style="display: none;">
                                <i class="fas fa-shopping-cart"></i> Order on Instacart
                            </a>
                            <a id="amazon-fresh-link" href="#" target="_blank" class="btn btn-success" style="display: none;">
                                <i class="fab fa-amazon"></i> Order on Amazon Fresh
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h3 class="mb-0">Meal Prep Schedule</h3>
        </div>
        <div class="card-body">
            <div id="prep-schedule">
                <!-- Meal prep schedule will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDay = 1;
    let weeklyPlan = null;
    let groceryList = null;

    // Add formatDay function
    function formatDay(day) {
        const dayNum = day.split('_')[1];
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return `${days[dayNum % 7]} (Day ${dayNum})`;
    }

    // Load initial nutrition advice
    fetchNutritionAdvice();

    // Form submission
    document.getElementById('mealPreferencesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateMealPlan();
    });

    // Day navigation
    document.getElementById('previousDay').addEventListener('click', function() {
        if (currentDay > 1) {
            currentDay--;
            updateMealPlanDisplay();
        }
    });

    document.getElementById('nextDay').addEventListener('click', function() {
        if (currentDay < 7) {
            currentDay++;
            updateMealPlanDisplay();
        }
    });

    async function fetchNutritionAdvice() {
        try {
            const response = await fetch('/health-insights/nutrition-advice');
            const data = await response.json();
            
            if (data.status === 'success') {
                updateNutritionProfile(data.data);
            } else {
                showError('Failed to load nutrition advice');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Failed to load nutrition advice');
        }
    }

    function updateNutritionProfile(nutrition) {
        document.getElementById('dailyCalories').textContent = Math.round(nutrition.target_calories);
        
        const protein = nutrition.macros.protein;
        const carbs = nutrition.macros.carbs;
        const fat = nutrition.macros.fat;
        
        document.getElementById('proteinBar').style.width = `${protein.percentage}%`;
        document.getElementById('carbsBar').style.width = `${carbs.percentage}%`;
        document.getElementById('fatBar').style.width = `${fat.percentage}%`;
        
        document.getElementById('proteinGrams').textContent = `${protein.grams}g`;
        document.getElementById('carbsGrams').textContent = `${carbs.grams}g`;
        document.getElementById('fatGrams').textContent = `${fat.grams}g`;
    }

    function updateMealPlanDisplay() {
        document.getElementById('currentDay').textContent = `Day ${currentDay}`;
        document.getElementById('previousDay').disabled = currentDay === 1;
        document.getElementById('nextDay').disabled = currentDay === 7;
        
        if (!weeklyPlan) return;
        
        const mealPlanDiv = document.getElementById('meal-plan');
        const dayKey = `day_${currentDay}`;
        const meals = weeklyPlan[dayKey];
        
        if (!meals) {
            mealPlanDiv.innerHTML = '<div class="alert alert-info">No meals planned for this day.</div>';
            return;
        }

        let html = `
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">${formatDay(dayKey)}</h4>
                </div>
                <div class="card-body">
                    ${Object.entries(meals).map(([mealType, details]) => `
                        <div class="meal-section mb-4">
                            <h5 class="text-capitalize">${mealType}</h5>
                            <div class="recipe-card">
                                <h6>${details.name}</h6>
                                <div class="ingredients-list mb-3">
                                    <strong>Ingredients:</strong>
                                    <ul class="list-unstyled">
                                        ${Object.entries(details.ingredients).map(([item, info]) => `
                                            <li>${info.amount}${info.unit} ${item}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="instructions-list">
                                    <strong>Instructions:</strong>
                                    <ol class="ps-3">
                                        ${details.instructions.map(step => `
                                            <li>${step}</li>
                                        `).join('')}
                                    </ol>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        mealPlanDiv.innerHTML = html;
    }

    function displayMealPlan(mealPlan) {
        weeklyPlan = mealPlan;  // Store the full meal plan
        updateMealPlanDisplay();  // Show current day's meals
    }

    function displayPrepSchedule(prepSchedule) {
        const prepScheduleDiv = document.getElementById('prep-schedule');
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <div class="prep-day mb-4">
                        <h4>Sunday Prep</h4>
                        <div class="list-group">
                            ${prepSchedule.prep_day_1.meals.map(meal => `
                                <div class="list-group-item">
                                    <h6 class="mb-1">${meal.recipe}</h6>
                                    <small>For: ${meal.day} - ${meal.meal}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="prep-day mb-4">
                        <h4>Wednesday Prep</h4>
                        <div class="list-group">
                            ${prepSchedule.prep_day_2.meals.map(meal => `
                                <div class="list-group-item">
                                    <h6 class="mb-1">${meal.recipe}</h6>
                                    <small>For: ${meal.day} - ${meal.meal}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            <div class="fresh-cooking mt-4">
                <h4>Fresh Cooking Required</h4>
                <div class="list-group">
                    ${prepSchedule.fresh_cooking.map(meal => `
                        <div class="list-group-item">
                            <h6 class="mb-1">${meal.recipe}</h6>
                            <small>On: ${meal.day} - ${meal.meal}</small>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        prepScheduleDiv.innerHTML = html;
    }

    function generateMealPlan() {
        const excludedFoods = document.getElementById('excluded-foods').value
            .split(',')
            .map(food => food.trim())
            .filter(food => food.length > 0);

        const preferences = {
            dietary_type: document.getElementById('dietary-type').value,
            excluded_foods: excludedFoods,
            meal_count: parseInt(document.getElementById('meal-count').value),
            servings: parseInt(document.getElementById('servings').value)
        };
        
        fetch("{{ url_for('health_insights.generate_meal_plan') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                weeklyPlan = data.data.meal_plan;
                updateMealPlanDisplay();
                updateGroceryList(data.data.grocery_list, data.data.shopping_links);
                displayPrepSchedule(data.data.prep_schedule);
                document.getElementById('meal-plan').style.display = 'block';
            } else {
                showError(data.message || 'Failed to generate meal plan');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('An error occurred while generating the meal plan');
        });
    }

    function updateGroceryList(groceryList, shoppingLinks) {
        const groceryListDiv = document.getElementById('grocery-list');
        let html = '<div class="row">';
        
        // Group items by category
        const categorizedItems = {};
        for (const [item, details] of Object.entries(groceryList)) {
            const category = item.includes('chicken') || item.includes('fish') || item.includes('beef') ? 'Proteins' :
                           item.includes('rice') || item.includes('pasta') || item.includes('bread') ? 'Carbs' :
                           item.includes('broccoli') || item.includes('spinach') || item.includes('carrot') ? 'Vegetables' :
                           item.includes('apple') || item.includes('banana') || item.includes('berr') ? 'Fruits' :
                           'Other';
            
            if (!categorizedItems[category]) {
                categorizedItems[category] = [];
            }
            categorizedItems[category].push({ item, ...details });
        }
        
        // Display items by category
        for (const [category, items] of Object.entries(categorizedItems)) {
            html += `
                <div class="col-md-6 mb-4">
                    <h5>${category}</h5>
                    <ul class="list-group">
                        ${items.map(({ item, amount, unit }) => `
                            <li class="list-group-item">
                                ${Math.round(amount * 10) / 10}${unit} ${item}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
        html += '</div>';
        groceryListDiv.innerHTML = html;
        
        // Update shopping links
        const instacartLink = document.getElementById('instacart-link');
        const amazonFreshLink = document.getElementById('amazon-fresh-link');
        
        if (shoppingLinks?.instacart?.url) {
            instacartLink.href = shoppingLinks.instacart.url;
            instacartLink.style.display = 'inline-block';
        } else {
            instacartLink.style.display = 'none';
        }
        
        if (shoppingLinks?.amazon_fresh?.url) {
            amazonFreshLink.href = shoppingLinks.amazon_fresh.url;
            amazonFreshLink.style.display = 'inline-block';
        } else {
            amazonFreshLink.style.display = 'none';
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }
});
</script>

<style>
.recipe-card {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    padding: 1rem;
    margin-top: 0.5rem;
}

.prep-day {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    padding: 1rem;
}

.fresh-cooking {
    background-color: #fff3cd;
    border-radius: 0.25rem;
    padding: 1rem;
}
</style>
{% endblock %} 