{% extends "base.html" %}

{% block title %}Health Insights Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div id="alertContainer" class="mb-4"></div>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <h1>Health Insights Dashboard</h1>
            <p class="lead">AI-powered health analysis and recommendations</p>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>Health Alerts</h3>
                </div>
                <div class="card-body">
                    <div id="alertsContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Heart Rate Analysis -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Heart Rate Analysis</h3>
                </div>
                <div class="card-body">
                    <div id="heartRateContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sleep Quality -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Sleep Quality</h3>
                </div>
                <div class="card-body">
                    <div id="sleepContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recovery Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Recovery Status</h3>
                </div>
                <div class="card-body">
                    <div id="recoveryContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nutrition Recommendations -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Nutrition Recommendations</h3>
                </div>
                <div class="card-body">
                    <div id="nutritionContainer">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const alertContainer = document.getElementById('alertContainer');
    const alertsContainer = document.getElementById('alertsContainer');
    const heartRateContainer = document.getElementById('heartRateContainer');
    const sleepContainer = document.getElementById('sleepContainer');
    const recoveryContainer = document.getElementById('recoveryContainer');
    const nutritionContainer = document.getElementById('nutritionContainer');

    // Function to show alerts
    function showAlerts(alerts) {
        alertsContainer.innerHTML = '';
        alerts.forEach(alert => {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${alert.severity === 'high' ? 'danger' : 'warning'} mb-3`;
            alertDiv.innerHTML = `
                <h4 class="alert-heading">${alert.message}</h4>
                <ul class="mb-0">
                    ${alert.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
            alertsContainer.appendChild(alertDiv);
        });
    }

    // Function to display heart rate insights
    function displayHeartRateInsights(insights) {
        heartRateContainer.innerHTML = `
            <div class="mb-3">
                <h4>Status: <span class="badge bg-${insights.status === 'normal' ? 'success' : insights.status === 'elevated' ? 'warning' : 'danger'}">${insights.status}</span></h4>
                <p>Confidence: ${(insights.confidence * 100).toFixed(1)}%</p>
            </div>
            <div>
                <h5>Recommendations:</h5>
                <ul>
                    ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    // Function to display sleep insights
    function displaySleepInsights(insights) {
        sleepContainer.innerHTML = `
            <div class="mb-3">
                <h4>Quality Score: <span class="badge bg-${insights.quality_score > 0.7 ? 'success' : insights.quality_score > 0.4 ? 'warning' : 'danger'}">${(insights.quality_score * 100).toFixed(1)}%</span></h4>
                <p>Status: ${insights.status}</p>
            </div>
            <div>
                <h5>Recommendations:</h5>
                <ul>
                    ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    // Function to display recovery insights
    function displayRecoveryInsights(insights) {
        recoveryContainer.innerHTML = `
            <div class="mb-3">
                <h4>Status: <span class="badge bg-${insights.status === 'ready' ? 'success' : insights.status === 'moderate' ? 'warning' : 'danger'}">${insights.status}</span></h4>
                <p>Confidence: ${(insights.confidence * 100).toFixed(1)}%</p>
            </div>
            <div>
                <h5>Recommendations:</h5>
                <ul>
                    ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    // Function to display nutrition insights
    function displayNutritionInsights(nutrition) {
        nutritionContainer.innerHTML = `
            <div class="mb-3">
                <h4>Daily Calorie Needs: ${nutrition.daily_calories} kcal</h4>
                <div class="progress mb-3">
                    <div class="progress-bar bg-success" role="progressbar" style="width: ${(nutrition.macros.protein / nutrition.daily_calories * 100).toFixed(1)}%" title="Protein">Protein</div>
                    <div class="progress-bar bg-info" role="progressbar" style="width: ${(nutrition.macros.carbs / nutrition.daily_calories * 100).toFixed(1)}%" title="Carbs">Carbs</div>
                    <div class="progress-bar bg-warning" role="progressbar" style="width: ${(nutrition.macros.fat / nutrition.daily_calories * 100).toFixed(1)}%" title="Fat">Fat</div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>Protein</h5>
                                <p class="mb-0">${nutrition.macros.protein}g</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>Carbs</h5>
                                <p class="mb-0">${nutrition.macros.carbs}g</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>Fat</h5>
                                <p class="mb-0">${nutrition.macros.fat}g</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h5>Hydration Needs:</h5>
                    <p>${nutrition.hydration}ml per day</p>
                </div>
            </div>
        `;
    }

    // Function to fetch and display all insights
    async function fetchInsights() {
        try {
            // Fetch alerts
            const alertsResponse = await fetch('/health-insights/alerts');
            const alertsData = await alertsResponse.json();
            if (alertsData.status === 'success') {
                showAlerts(alertsData.alerts);
            }

            // Fetch all insights
            const insightsResponse = await fetch('/health-insights/analyze');
            const insightsData = await insightsResponse.json();
            
            if (insightsData.status === 'success') {
                displayHeartRateInsights(insightsData.data.heart_rate);
                displaySleepInsights(insightsData.data.sleep);
                displayRecoveryInsights(insightsData.data.recovery);
                displayNutritionInsights(insightsData.data.nutrition);
            }
        } catch (error) {
            console.error('Error fetching insights:', error);
            alertContainer.innerHTML = `
                <div class="alert alert-danger">
                    Error loading health insights. Please try again later.
                </div>
            `;
        }
    }

    // Initial fetch
    fetchInsights();

    // Refresh every 5 minutes
    setInterval(fetchInsights, 5 * 60 * 1000);
});
</script>
{% endblock %}
{% endblock %} 