{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Nutrition Profile -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Your Nutrition Profile</h3>
                </div>
                <div class="card-body">
                    <div id="nutritionProfile">
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Daily Calories</h5>
                                <div class="display-4 mb-3" id="dailyCalories">-</div>
                            </div>
                            <div class="col-md-8">
                                <h5>Macronutrient Distribution</h5>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar bg-primary" id="proteinBar" role="progressbar"></div>
                                    <div class="progress-bar bg-success" id="carbsBar" role="progressbar"></div>
                                    <div class="progress-bar bg-warning" id="fatBar" role="progressbar"></div>
                                </div>
                                <div class="row text-center">
                                    <div class="col">
                                        <small class="text-primary">Protein</small>
                                        <div id="proteinGrams">-</div>
                                    </div>
                                    <div class="col">
                                        <small class="text-success">Carbs</small>
                                        <div id="carbsGrams">-</div>
                                    </div>
                                    <div class="col">
                                        <small class="text-warning">Fat</small>
                                        <div id="fatGrams">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meal Preferences Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Meal Preferences</h3>
                </div>
                <div class="card-body">
                    <form id="mealPreferencesForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dietary-type" class="form-label">Dietary Type</label>
                                    <select class="form-select" id="dietary-type" name="dietary_type">
                                        <option value="balanced">Balanced</option>
                                        <option value="vegetarian">Vegetarian</option>
                                        <option value="vegan">Vegan</option>
                                        <option value="keto">Keto</option>
                                        <option value="paleo">Paleo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="meal-count" class="form-label">Meals per Day</label>
                                    <select class="form-select" id="meal-count" name="meal_count">
                                        <option value="4">4 (Breakfast, Lunch, Snack, Dinner)</option>
                                        <option value="5">5 (+ Morning Snack)</option>
                                        <option value="6">6 (+ Evening Snack)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="excluded-foods" class="form-label">Excluded Foods</label>
                                    <select class="form-select" id="excluded-foods" name="excluded_foods" multiple>
                                        <option value="nuts">Nuts</option>
                                        <option value="shellfish">Shellfish</option>
                                        <option value="dairy">Dairy</option>
                                        <option value="eggs">Eggs</option>
                                        <option value="soy">Soy</option>
                                        <option value="gluten">Gluten</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Meal Plan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Meal Plan -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Weekly Meal Plan</h3>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="previousDay">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="btn btn-outline-primary" id="currentDay" disabled>Day 1</button>
                        <button class="btn btn-outline-primary" id="nextDay">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="mealPlan">
                        <!-- Meal plan will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grocery List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Grocery List</h3>
                </div>
                <div class="card-body">
                    <div id="grocery-list">
                        <!-- Grocery list will be populated here -->
                    </div>
                    <div id="shopping-links" class="mt-4">
                        <h4>Order Groceries</h4>
                        <div class="d-flex gap-3">
                            <a id="instacart-link" href="#" target="_blank" class="btn btn-primary" style="display: none;">
                                <i class="fas fa-shopping-cart"></i> Order on Instacart
                            </a>
                            <a id="amazon-fresh-link" href="#" target="_blank" class="btn btn-success" style="display: none;">
                                <i class="fab fa-amazon"></i> Order on Amazon Fresh
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDay = 1;
    let weeklyPlan = null;
    let groceryList = null;

    // Load initial nutrition advice
    fetchNutritionAdvice();

    // Form submission
    document.getElementById('mealPreferencesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const preferences = {
            dietary_type: document.getElementById('dietary-type').value,
            excluded_foods: Array.from(document.getElementById('excluded-foods').selectedOptions).map(opt => opt.value),
            meal_count: parseInt(document.getElementById('meal-count').value)
        };
        
        fetch("{{ url_for('health_insights.generate_meal_plan') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                weeklyPlan = data.data.weekly_plan;
                groceryList = data.data.grocery_list;
                currentDay = 1;
                updateMealPlanDisplay();
                updateGroceryList(data.data.grocery_list, data.data.shopping_links);
            } else {
                showError(data.message || 'Failed to generate meal plan');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('An error occurred while generating the meal plan');
        });
    });

    // Day navigation
    document.getElementById('previousDay').addEventListener('click', function() {
        if (currentDay > 1) {
            currentDay--;
            updateMealPlanDisplay();
        }
    });

    document.getElementById('nextDay').addEventListener('click', function() {
        if (currentDay < 7) {
            currentDay++;
            updateMealPlanDisplay();
        }
    });

    async function fetchNutritionAdvice() {
        try {
            const response = await fetch('/health-insights/nutrition-advice');
            const data = await response.json();
            
            if (data.status === 'success') {
                updateNutritionProfile(data.data);
            } else {
                showError('Failed to load nutrition advice');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Failed to load nutrition advice');
        }
    }

    function updateNutritionProfile(nutrition) {
        document.getElementById('dailyCalories').textContent = Math.round(nutrition.target_calories);
        
        const protein = nutrition.macros.protein;
        const carbs = nutrition.macros.carbs;
        const fat = nutrition.macros.fat;
        
        document.getElementById('proteinBar').style.width = `${protein.percentage}%`;
        document.getElementById('carbsBar').style.width = `${carbs.percentage}%`;
        document.getElementById('fatBar').style.width = `${fat.percentage}%`;
        
        document.getElementById('proteinGrams').textContent = `${protein.grams}g`;
        document.getElementById('carbsGrams').textContent = `${carbs.grams}g`;
        document.getElementById('fatGrams').textContent = `${fat.grams}g`;
    }

    function updateMealPlanDisplay() {
        document.getElementById('currentDay').textContent = `Day ${currentDay}`;
        document.getElementById('previousDay').disabled = currentDay === 1;
        document.getElementById('nextDay').disabled = currentDay === 7;
        
        if (!weeklyPlan) return;
        
        const dayPlan = weeklyPlan[`day_${currentDay}`];
        const mealPlanContainer = document.getElementById('mealPlan');
        mealPlanContainer.innerHTML = '';
        
        for (const [meal, details] of Object.entries(dayPlan)) {
            const mealCard = document.createElement('div');
            mealCard.className = 'card mb-3';
            mealCard.innerHTML = `
                <div class="card-header">
                    <h5 class="mb-0">${meal.replace('_', ' ').toUpperCase()}</h5>
                </div>
                <div class="card-body">
                    <h6>${details.name}</h6>
                    <p>Calories: ${details.calories}</p>
                    <div class="row">
                        <div class="col">
                            <small>Protein: ${details.macros.protein.grams}g</small>
                        </div>
                        <div class="col">
                            <small>Carbs: ${details.macros.carbs.grams}g</small>
                        </div>
                        <div class="col">
                            <small>Fat: ${details.macros.fat.grams}g</small>
                        </div>
                    </div>
                    <hr>
                    <h6>Ingredients:</h6>
                    <ul class="list-unstyled">
                        ${details.ingredients.map(ingredient => 
                            `<li>${ingredient.amount}${ingredient.unit} ${ingredient.name}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
            mealPlanContainer.appendChild(mealCard);
        }
    }

    function updateGroceryList(groceryList, shoppingLinks) {
        const groceryListDiv = document.getElementById('grocery-list');
        let html = '<div class="row">';
        
        // Display grocery items by category
        for (const [category, items] of Object.entries(groceryList)) {
            html += `
                <div class="col-md-6 mb-4">
                    <h5 class="text-capitalize">${category}</h5>
                    <ul class="list-group">
                        ${Object.entries(items).map(([item, details]) => `
                            <li class="list-group-item">
                                ${details.amount}${details.unit} ${item}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
        html += '</div>';
        groceryListDiv.innerHTML = html;
        
        // Display shopping links
        if (shoppingLinks) {
            const instacartLink = document.getElementById('instacart-link');
            const amazonFreshLink = document.getElementById('amazon-fresh-link');
            
            if (shoppingLinks.instacart) {
                instacartLink.href = shoppingLinks.instacart.url;
                instacartLink.style.display = 'inline-block';
            }
            
            if (shoppingLinks.amazon_fresh) {
                amazonFreshLink.href = shoppingLinks.amazon_fresh.url;
                amazonFreshLink.style.display = 'inline-block';
            }
        }
    }

    function showError(message) {
        // Add error handling UI here
        alert(message);
    }
});
</script>
{% endblock %} 